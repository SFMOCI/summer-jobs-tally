<html>
<head>
<title>Mayor's Summer Jobs Challenge</title>
<link href='http://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link href="main.css">
</head>

<body>
  <div style="max-height: 100%;">
    <div class="row" style="background-color:#56ADE0;color:#fff;">
    	<div class="col-md-2"><img src="http://sfsummerjobs.org/wp-content/uploads/2013/05/logo.png" style="margin-bottom:2.5em;margin-left:1.5em;height:10em;padding-top:1em;display:block;-webkit-filter: drop-shadow(10px 10px 5px #222); filter: drop-shadow(10px 10px 5px #222); "></div>
      <div id='jobsNo' class="col-md-5 jobsno" style="font-family:Montserrat;text-align:left;font-size:4em;margin-top:0.3em;"></div>
      
      <div id='goalNo' class="col-md-5 " style="font-family:Montserrat;text-align:left;font-size:4em;margin-top:0.3em;">#sfsummerjobs</div>
       <div class="col-md-10">
  			 <div id='jobsLabel' class="col-md-5" style="font-family:Montserrat;text-align:left;font-size:2em;margin-bottom:0.5em;padding-left:0em;">
  				Total Jobs Pledged
  			</div>
  			 <div id='goalLabel' class="col-md-5" style="font-family:Montserrat;text-align:left;font-size:2em;margin-bottom:0.5em;padding-left:4em">
  			</div>
      </div>
    </div>
    <div class="row">
      <div id='chart' class="col-sm-9 chart" style="height:calc(100% - 13em)"></div>
      <div class="col-sm-3"></div>
    </div>
  </div>
  <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>

  <script type="text/javascript">
  google.load("visualization", '1', {packages:['table','corechart']});
  var firstTime = true;
  var chart;
  var chartData;
  var prevView;
  var view;
  var options;
  var query;
  google.setOnLoadCallback(drawChart);

  function drawChart() {
    query = new google.visualization.Query(
        'https://docs.google.com/spreadsheets/d/1eko8LIH17ZXOKfWEEQtOBr5dOWQEU-jLDxi48Qj2-Q8/gviz/tq?gid=715717633&headers=1&range=A%3AD');
    query.setRefreshInterval(1);
    query.send(handleQueryResponse);
  }

  function handleQueryResponse(response) {
    console.log('query');
    if (response.isError()) {
      alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
      return;
    }
    console.log(firstTime)
      // Grab data from the response, this will be the full spreadsheet
      chartData = response.getDataTable();
      totalJobs = chartData.getColumnLabel(3);
      existingJobs = $('div#jobsNo').html();
      if(firstTime || totalJobs != existingJobs) {
        $('div#jobsNo').html(totalJobs);
        $( "div#jobsNo" )
          .animate({
            fontSize: '5em'
          }, 750)
          .animate({
            fontSize: '3.5em'
          }, 500)
          .animate({
            fontSize: '4em'
          }, 500)
      }
      chartData.removeColumns(2,2);
      chartData.sort([{column: 1, desc: true}])
      view = new google.visualization.DataView(chartData);
      view.setRows(view.getFilteredRows([{column: 1, minValue: 1}]));
      options = {
            /*title: 'Number of Jobs Pledged',*/
            legend: {position: 'none'},
            hAxis: {baselineColor:'#fff'},
            /*hAxis.gridlines: {color:'#fff'},*/
            fontName: 'Montserrat',
            chartArea: {left:180, top:0, width: '80%',height: '95%'},
            colors:['#56ADE0'],
            animation:{
              duration: 1000,
              easing: 'out',
            }
      };
    if(firstTime) { 
      chart = new google.visualization.BarChart(document.getElementById('chart'));
      chart.draw(view, options);
      firstTime = false;
    } else {
      query.setRefreshInterval(0);
      chart.draw(view, options);
      google.visualization.events.addListener(chart, 'animationfinish',
          function() {
            query.setRefreshInterval(1);
          });
    }
    prevView = view;
  }

  </script>
</body>
</html>